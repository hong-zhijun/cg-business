
# =========================================================
# ChatGPT Team 自动邀请系统 - Nginx 配置文件
# =========================================================

# ---------------------------------------------------------
# 1. 用户端域名 (business.moyuing.online)
# 功能：仅允许访问首页、API接口和静态资源，其他路径一律跳回首页
# ---------------------------------------------------------
server {
    listen 80;
    server_name business.moyuing.online;

    # [核心修复] 必须放行 API 接口！
    # 之前的配置把 /api/join 也重定向回首页了，导致前端无法发送请求
    location /api/ {
        proxy_pass http://127.0.0.1:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # [核心修复] 必须放行 Flask 的静态资源目录
    # Flask 默认静态文件都在 /static/ 下
    location /static/ {
        proxy_pass http://127.0.0.1:5002;
    }

    # 首页正常访问
    location = / {
        proxy_pass http://127.0.0.1:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 兜底策略：其他乱七八糟的路径全部强制重定向回首页
    # 例如用户访问 /abc，自动跳回 /
    location / {
        return 302 /;
    }
}

# ---------------------------------------------------------
# 2. 管理端域名 (busmanager.moyuing.online)
# 功能：自动跳转到 /admin，且保证 API 和静态资源正常加载
# ---------------------------------------------------------
server {
    listen 80;
    server_name busmanager.moyuing.online;
    client_max_body_size 50M;

    # [优化] 访问域名根目录时，自动跳转到 /admin
    location = / {
        return 302 /admin;
    }

    # [核心修复] 这里不能写 proxy_pass .../admin
    # 否则 /static/style.css 会被代理成 /admin/static/style.css 导致 404
    # 也不要拦截 /api/，直接全部透传给后端即可
    location / {
        proxy_pass http://127.0.0.1:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 支持 WebSocket (可选，防止未来有长连接需求)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
