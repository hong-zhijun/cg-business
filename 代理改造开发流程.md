# 代理功能改造开发流程 (基于 Account ID)

## 目标

修改 `app_new.py`，使所有涉及 OpenAI (ChatGPT) 的接口请求都能使用 Team 绑定的代理配置。
**优化方案**：利用 `account_id` 查询代理，避免修改现有函数的参数列表，保持代码侵入性最小。

## 核心逻辑

由于 `account_id` 与 Team 一一对应（且 Team 绑定了 Proxy），我们可以通过 `account_id` -> `Team` -> `Proxy` 的链路获取代理配置。

## 开发步骤

### 第一步：扩展数据库查询方法

在 `database.py` 的 `Team` 类中添加通过 `account_id` 查询 Team 的方法。

**修改文件**: `database.py`
**代码示例**:

```python
class Team:
    # ... 现有代码 ...

    @staticmethod
    def get_by_account_id(account_id):
        """根据 account_id 获取 Team (用于查询代理)"""
        with get_db() as conn:
            cursor = conn.cursor()
            cursor.execute('SELECT * FROM teams WHERE account_id = ? LIMIT 1', (account_id,))
            row = cursor.fetchone()
            return dict(row) if row else None
```

### 第二步：在 app_new.py 封装代理获取函数

在 `app_new.py` 中新增辅助函数，逻辑与 `login.py` 的 `parse_proxy_str` 类似，但源头是数据库。

**修改文件**: `app_new.py`
**建议位置**: 文件开头导入部分之后，或与其他工具函数放在一起。
**代码示例**:

```python
from database import Team, ProxyAddress  # 确保导入

def get_proxies_by_account(account_id):
    """
    根据 account_id 获取 requests 兼容的代理字典
    """
    if not account_id:
        return None

    # 1. 查找 Team
    team = Team.get_by_account_id(account_id)
    if not team or not team.get('proxy_id'):
        return None

    # 2. 查找 Proxy
    proxy = ProxyAddress.get_by_id(team['proxy_id'])
    if not proxy:
        return None

    # 3. 构造代理字符串 (参考 login.py)
    protocol = proxy['protocol']  # http, socks5 等
    ip = proxy['ip']
    port = proxy['port']
    username = proxy.get('username')
    password = proxy.get('password')

    if username and password:
        # 格式: protocol://user:pass@ip:port
        proxy_url = f"{protocol}://{username}:{password}@{ip}:{port}"
    else:
        # 格式: protocol://ip:port
        proxy_url = f"{protocol}://{ip}:{port}"

    return {
        "http": proxy_url,
        "https": proxy_url
    }
```

### 第三步：应用到 OpenAI 接口调用

在 `app_new.py` 中找到所有调用 `cf_requests` 访问 OpenAI 的函数，插入代理获取逻辑。

**需要修改的函数列表** (均含有 `account_id` 参数):

1.  **`invite_to_team`**

    ```python
    def invite_to_team(access_token, account_id, email, team_id=None):
        # 新增: 获取代理
        proxies = get_proxies_by_account(account_id)
        # 修改: 传入 proxies
        resp = cf_requests.post(..., proxies=proxies)
    ```

2.  **`cancel_invite_from_openai`**

    ```python
    def cancel_invite_from_openai(access_token, account_id, email):
        proxies = get_proxies_by_account(account_id)
        resp = cf_requests.post(..., proxies=proxies)
    ```

3.  **`get_team_subscription`**

    ```python
    def get_team_subscription(access_token, account_id):
        proxies = get_proxies_by_account(account_id)
        resp = cf_requests.get(..., proxies=proxies)
    ```

4.  **`cancel_subscription_from_openai`**

    ```python
    def cancel_subscription_from_openai(access_token, account_id):
        proxies = get_proxies_by_account(account_id)
        resp = cf_requests.post(..., proxies=proxies)
    ```

5.  **`get_team_members`**

    ```python
    def get_team_members(access_token, account_id, team_id=None):
        proxies = get_proxies_by_account(account_id)
        resp = cf_requests.get(..., proxies=proxies)
    ```

6.  **`get_pending_invites`**

    ```python
    def get_pending_invites(access_token, account_id):
        proxies = get_proxies_by_account(account_id)
        resp = cf_requests.get(..., proxies=proxies)
    ```

7.  **`kick_member`**
    ```python
    def kick_member(access_token, account_id, user_id):
        proxies = get_proxies_by_account(account_id)
        resp = cf_requests.post(..., proxies=proxies)
    ```

### 第四步：验证

1.  在后台为一个 Team 绑定代理。
2.  触发该 Team 的相关操作（如刷新成员列表）。
3.  验证请求是否成功且走了代理。
