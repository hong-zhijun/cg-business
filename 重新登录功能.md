# Team 重新登录功能开发指南

## 1. 功能描述
在 Admin 后台的 Team 详情弹窗中，增加一个“重新登录”按钮。点击该按钮后，后端将使用 Team 备注中的账号密码以及关联的代理信息，调用登录接口重新获取 Session Token，并自动更新到数据库中。

## 2. 开发步骤

### 第一步：后端 API 开发 (`app_new.py`)

在 `app_new.py` 中新增一个路由处理重新登录请求。

**API 路径**: `/api/admin/teams/<int:team_id>/relogin`
**方法**: `POST`
**权限**: 需要管理员权限 (`@admin_required`)

**实现逻辑**:
1.  **获取 Team 信息**: 使用 `Team.get_by_id(team_id)` 获取 Team 详情。
2.  **解析账号密码**:
    *   从 Team 的 `note` 字段获取备注信息。
    *   按 `----` 分割字符串。
    *   `email` 为分割后的第 0 个元素，`password` 为第 1 个元素。
    *   如果 `note` 为空或格式不正确，返回错误提示。
3.  **获取代理信息**:
    *   获取 Team 的 `proxy_id`。
    *   如果有 `proxy_id`，调用 `ProxyAddress.get_by_id(proxy_id)` 获取代理详情。
    *   构建代理字符串 `proxy_str`，格式为: `protocol,ip,port,username,password`。
    *   如果无 `proxy_id`，则 `proxy_str` 为 `None`。
4.  **调用登录接口**:
    *   引入登录方法: `from login_package import login`。
    *   调用 `result = login(email, password, proxy_str=proxy_str)`。
5.  **处理结果**:
    *   如果 `result` 不为空 (登录成功):
        *   调用 `Team.update_token(team_id, result)` 更新数据库中的 Token。
        *   返回成功 JSON: `{"success": True, "message": "重新登录成功"}`。
    *   如果 `result` 为空 (登录失败):
        *   返回失败 JSON: `{"success": False, "error": "登录失败，请检查账号密码或代理"}`。

**代码参考**:
```python
# app_new.py

from login_package import login

@app.route('/api/admin/teams/<int:team_id>/relogin', methods=['POST'])
@admin_required
def relogin_team(team_id):
    # 1. 获取 Team 信息
    team = Team.get_by_id(team_id)
    if not team:
        return jsonify({'success': False, 'error': 'Team 不存在'})

    # 2. 解析账号密码
    note = team.get('note', '')
    if not note or '----' not in note:
        return jsonify({'success': False, 'error': '备注格式错误或为空，请确保格式为: email----password'})
    
    try:
        parts = note.split('----')
        email = parts[0].strip()
        password = parts[1].strip()
    except IndexError:
        return jsonify({'success': False, 'error': '备注解析失败'})

    # 3. 获取代理信息
    proxy_str = None
    proxy_id = team.get('proxy_id')
    if proxy_id:
        proxy = ProxyAddress.get_by_id(proxy_id)
        if proxy:
            # 格式: 代理类型,ip,端口,用户名,密码
            # 注意: 数据库中 protocol 可能为 http/socks5，login 方法需要对应格式
            # 假设 proxy['protocol'] 直接可用，或者默认为 http
            protocol = proxy.get('protocol', 'http')
            ip = proxy.get('ip')
            port = proxy.get('port')
            username = proxy.get('username', '')
            pwd = proxy.get('password', '')
            
            proxy_str = f"{protocol},{ip},{port},{username},{pwd}"

    # 4. 调用登录接口
    try:
        print(f"尝试重新登录 Team {team_id}: {email} (Proxy: {'Yes' if proxy_str else 'No'})")
        session_data = login(email, password, proxy_str=proxy_str)
        
        if session_data:
            # 5. 更新 Token
            Team.update_token(team_id, session_data)
            return jsonify({'success': True, 'message': '重新登录成功，Token 已更新'})
        else:
            return jsonify({'success': False, 'error': '登录失败，未获取到 Session'})
            
    except Exception as e:
        print(f"重新登录异常: {e}")
        return jsonify({'success': False, 'error': f'系统异常: {str(e)}'})
```

### 第二步：前端 UI 开发 (`templates/modals/team_details.html`)

在 Team 详情弹窗中添加按钮，并绑定点击事件。

**修改位置**: `templates/modals/team_details.html`

1.  **添加按钮**:
    在现有的按钮组中（例如“更新 Token”按钮旁边），添加一个新的按钮。

```html
<!-- 在 update_token_btn 之前或之后添加 -->
<button
    id="relogin_btn"
    class="w-full flex justify-center items-center px-4 py-2 bg-blue-50 border border-blue-200 shadow-sm text-sm font-medium rounded-lg text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all gap-2">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
    </svg>
    重新登录
</button>
```

2.  **绑定事件**:
    在 `<script>` 标签中的 `showTeamDetails(teamId)` 函数里，绑定按钮点击事件。

```javascript
// 在 showTeamDetails 函数内部
document.getElementById("relogin_btn").onclick = function() {
    reloginTeam(team.id);
};
```

3.  **实现 JS 函数**:
    添加 `reloginTeam` 函数来调用后端接口。

```javascript
async function reloginTeam(teamId) {
    if (!confirm("确定要使用备注中的账号密码重新登录吗？这将覆盖当前的 Token。")) {
        return;
    }

    const btn = document.getElementById("relogin_btn");
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg class="animate-spin h-4 w-4 text-blue-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 登录中...';

    try {
        const response = await fetch(`/api/admin/teams/${teamId}/relogin`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            }
        });

        const data = await response.json();

        if (data.success) {
            alert("登录成功！");
            closeModal("teamDetailsModal");
            loadTeams(); // 刷新列表
        } else {
            alert("登录失败: " + data.error);
        }
    } catch (error) {
        alert("请求失败: " + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
```

## 3. 注意事项
- 确保 `login_package` 模块已正确导入。
- 确保 Team 的 `note` 字段格式严格为 `email----password`。
- 确保代理配置（如果存在）是有效的。
