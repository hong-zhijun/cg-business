<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Team 管理后台</title>
        <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}" />
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: "#2563eb",
                            secondary: "#64748b",
                            danger: "#dc2626",
                            success: "#16a34a",
                        },
                    },
                },
            };
        </script>
    </head>

    <body class="bg-gray-50 text-gray-800 min-h-screen font-sans">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 标题栏 -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="h-10 w-10 rounded-lg object-contain" />
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Team 管理后台</h1>
                        <p class="text-gray-500 text-sm mt-1">高效管理您的团队与成员</p>
                    </div>
                </div>
            </div>

            <!-- 顶部操作栏 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
                <div class="flex items-center justify-between gap-6">
                    <!-- 左侧按钮组 -->
                    <div class="flex items-center gap-3 flex-wrap">
                        <!-- 组1: 邀请码管理 -->
                        <div class="flex items-center gap-2">
                            <button
                                onclick="openKeysListModal()"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all group">
                                <svg
                                    class="w-4 h-4 mr-2 text-gray-400 group-hover:text-blue-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                </svg>
                                邀请码管理
                            </button>
                            <!-- <button
                            onclick="openCreateKeyModal()"
                            class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            新增邀请码
                        </button> -->
                        </div>

                        <div class="w-px h-6 bg-gray-200"></div>

                        <!-- 组2: 邀请与记录 -->
                        <div class="flex items-center gap-2">
                            <button
                                onclick="openInvitationsModal()"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-emerald-50 hover:text-emerald-700 hover:border-emerald-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all group">
                                <svg
                                    class="w-4 h-4 mr-2 text-gray-400 group-hover:text-emerald-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                邀请记录
                            </button>
                        </div>

                        <div class="w-px h-6 bg-gray-200"></div>

                        <!-- 组3: 踢人与安全 -->
                        <div class="flex items-center gap-2">
                            <button
                                onclick="openKickLogsModal()"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-orange-50 hover:text-orange-700 hover:border-orange-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-all group">
                                <svg
                                    class="w-4 h-4 mr-2 text-gray-400 group-hover:text-orange-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                踢人日志
                            </button>
                            <button
                                onclick="openModal('autoKickConfigModal')"
                                class="inline-flex items-center px-3 py-2 border border-orange-200 shadow-sm text-sm font-medium rounded-lg text-orange-700 bg-white hover:bg-orange-50 hover:border-orange-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-all group">
                                <svg
                                    class="w-4 h-4 mr-2 text-orange-500 group-hover:text-orange-600"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c-.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                自动踢人
                            </button>

                            <div class="w-px h-6 bg-gray-200 mx-1"></div>

                            <button
                                onclick="openSourcesModal()"
                                class="inline-flex items-center px-3 py-2 border border-purple-200 shadow-sm text-sm font-medium rounded-lg text-purple-700 bg-white hover:bg-purple-50 hover:border-purple-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all group">
                                <svg
                                    class="w-4 h-4 mr-2 text-purple-500 group-hover:text-purple-600"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                </svg>
                                编辑来源
                            </button>
                            <button
                                onclick="openMailConfigModal()"
                                class="inline-flex items-center px-3 py-2 border border-blue-200 shadow-sm text-sm font-medium rounded-lg text-blue-700 bg-white hover:bg-blue-50 hover:border-blue-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all group">
                                <svg
                                    class="w-4 h-4 mr-2 text-blue-500 group-hover:text-blue-600"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                邮件设置
                            </button>
                            <button
                                onclick="openSystemConfigModal()"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 hover:border-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all group">
                                <svg
                                    class="w-4 h-4 mr-2 text-gray-500 group-hover:text-gray-600"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c-.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                系统配置
                            </button>
                        </div>
                    </div>

                    <!-- 右侧统计 -->
                    <div class="flex items-center gap-3">
                        <!-- Team 总数 -->
                        <div class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200" title="Team 总数">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                            <span class="text-lg font-bold text-gray-700" id="totalTeamsCount">-</span>
                        </div>

                        <!-- 成员总数 -->
                        <div
                            onclick="openRankingModal()"
                            class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 cursor-pointer hover:shadow-md transition-shadow"
                            title="点击查看来源排行榜 (成员总数)">
                            <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                            </svg>
                            <span class="text-lg font-bold text-blue-700" id="totalMembersCount">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teams 列表 -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 pb-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                        <span class="bg-blue-50 text-blue-600 p-1.5 rounded-lg mr-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </span>
                        Teams 列表
                    </h2>

                    <!-- 功能按钮组 -->
                    <div class="flex flex-wrap gap-2 items-center">
                        <!-- 邮箱搜索框 -->
                        <div class="flex items-center gap-2">
                            <div class="relative">
                                <input
                                    type="email"
                                    id="emailSearch"
                                    placeholder="搜索邮箱..."
                                    class="pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all w-64" />
                                <svg
                                    class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <button
                                onclick="searchByEmail()"
                                class="inline-flex items-center px-3 py-2 border border-blue-200 shadow-sm text-sm font-medium rounded-lg text-blue-700 bg-white hover:bg-blue-50 hover:border-blue-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                搜索
                            </button>
                            <button
                                onclick="clearSearch()"
                                id="clearSearchBtn"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all"
                                style="display: none">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                清除
                            </button>
                        </div>
                        <div class="w-px h-8 bg-gray-200"></div>
                        <button
                            onclick="openModal('addTeamModal')"
                            class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            添加 Team
                        </button>
                        <div class="w-px h-8 bg-gray-200 mx-1"></div>
                        <button
                            onclick="deleteExpiredTeams()"
                            class="inline-flex items-center px-3 py-2 border border-red-200 shadow-sm text-sm font-medium rounded-lg text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            清理过期
                        </button>
                    </div>
                </div>

                <div id="teamsList" class="overflow-x-auto">
                    <!-- 表格内容由 JS 生成 -->
                    <p class="text-gray-500 text-sm italic text-center py-4">加载中...</p>
                </div>
            </div>
        </div>

        <!-- ================== Modals ================== -->
        {% include 'modals/add_team.html' %} {% include 'modals/admin_invite.html' %} {% include 'modals/manual_kick.html' %} {% include
        'modals/auto_kick_config.html' %} {% include 'modals/members.html' %} {% include 'modals/team_details.html' %} {% include
        'modals/invite_member.html' %} {% include 'modals/update_token.html' %} {% include 'modals/keys_list.html' %} {% include
        'modals/create_key.html' %} {% include 'modals/kick_logs.html' %} {% include 'modals/invitations.html' %} {% include 'modals/sources.html' %}
        {% include 'modals/ranking.html' %} {% include 'modals/mail_config.html' %}

        <div
            id="alertModal"
            class="modal fixed inset-0 z-50 bg-gray-900 bg-opacity-50 overflow-y-auto backdrop-blur-sm flex items-center justify-center"
            style="display: none">
            <div class="relative bg-white rounded-xl shadow-2xl border border-gray-200 p-6 w-full max-w-md mx-4 transition-all transform">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-900">提示</h2>
                    <button onclick="closeModal('alertModal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="alertMessage" class="text-gray-700 whitespace-pre-line"></div>
                <div class="flex justify-end gap-3 mt-6">
                    <button
                        onclick="closeModal('alertModal')"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm transition-colors">
                        确定
                    </button>
                </div>
            </div>
        </div>

        <div
            id="confirmModal"
            class="modal fixed inset-0 z-50 bg-gray-900 bg-opacity-50 overflow-y-auto backdrop-blur-sm flex items-center justify-center"
            style="display: none">
            <div class="relative bg-white rounded-xl shadow-2xl border border-gray-200 p-6 w-full max-w-md mx-4 transition-all transform">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-900">确认</h2>
                    <button id="confirmClose" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="confirmMessage" class="text-gray-700 whitespace-pre-line"></div>
                <div class="flex justify-end gap-3 mt-6">
                    <button id="confirmCancel" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button id="confirmOk" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm transition-colors">
                        确定
                    </button>
                </div>
            </div>
        </div>

        <script>
            let currentTeamId = null;
            let allTeamsData = []; // 存储所有Teams数据
            let teamsLoaded = false;

            window.onload = function () {
                loadTeams(); // 自动加载 Teams
                loadTotalMembersCount(); // 加载成员总数
                loadAutoKickConfig();

                // These listeners depend on elements that are now in included files.
                // Since scripts in includes run immediately, the DOM elements should exist if the include places them in the DOM.
                // But verify if these elements IDs are unique and present.
                // The included HTML is injected into the body. So document.getElementById should find them.

                const inviteTempCheckbox = document.getElementById("invite_is_temp");
                if (inviteTempCheckbox) {
                    inviteTempCheckbox.addEventListener("change", function () {
                        document.getElementById("temp_hours_group").style.display = this.checked ? "block" : "none";
                    });
                }

                const adminInviteTempCheckbox = document.getElementById("admin_invite_is_temp");
                if (adminInviteTempCheckbox) {
                    adminInviteTempCheckbox.addEventListener("change", function () {
                        document.getElementById("admin_temp_hours_group").style.display = this.checked ? "block" : "none";
                    });
                }
            };

            // 通用模态框控制
            function openModal(modalId) {
                document.getElementById(modalId).style.display = "flex";
            }

            function closeModal(modalId) {
                document.getElementById(modalId).style.display = "none";
            }

            function showConfirm(msg) {
                return new Promise(function (resolve) {
                    var messageEl = document.getElementById("confirmMessage");
                    var modalEl = document.getElementById("confirmModal");
                    var okBtn = document.getElementById("confirmOk");
                    var cancelBtn = document.getElementById("confirmCancel");
                    var closeBtn = document.getElementById("confirmClose");
                    if (!messageEl || !modalEl || !okBtn || !cancelBtn) {
                        var nativeConfirm = window.confirm;
                        resolve(nativeConfirm(String(msg)));
                        return;
                    }
                    messageEl.textContent = String(msg);
                    openModal("confirmModal");
                    function cleanup() {
                        okBtn.removeEventListener("click", onOk);
                        cancelBtn.removeEventListener("click", onCancel);
                        modalEl.removeEventListener("click", onOverlay);
                        if (closeBtn) closeBtn.removeEventListener("click", onCancel);
                    }
                    function onOk(e) {
                        e.stopPropagation();
                        cleanup();
                        closeModal("confirmModal");
                        resolve(true);
                    }
                    function onCancel(e) {
                        e.stopPropagation();
                        cleanup();
                        closeModal("confirmModal");
                        resolve(false);
                    }
                    function onOverlay(e) {
                        if (e.target && e.target.id === "confirmModal") {
                            cleanup();
                            closeModal("confirmModal");
                            resolve(false);
                        }
                    }
                    okBtn.addEventListener("click", onOk);
                    cancelBtn.addEventListener("click", onCancel);
                    if (closeBtn) closeBtn.addEventListener("click", onCancel);
                    modalEl.addEventListener("click", onOverlay);
                });
            }

            (function () {
                const nativeAlert = window.alert;
                window.alert = function (msg) {
                    const messageEl = document.getElementById("alertMessage");
                    const modalEl = document.getElementById("alertModal");
                    if (messageEl && modalEl) {
                        messageEl.textContent = String(msg);
                        openModal("alertModal");
                    } else {
                        nativeAlert(String(msg));
                    }
                };
            })();

            async function loadTeams() {
                try {
                    const response = await fetch("/api/admin/teams");
                    const data = await response.json();

                    if (data.success) {
                        allTeamsData = data.teams; // 保存数据
                        teamsLoaded = true;
                        displayTeams(data.teams);
                    }
                } catch (error) {
                    console.error("加载 Teams 失败:", error);
                }
            }

            // 加载成员总数
            async function loadTotalMembersCount() {
                try {
                    const response = await fetch("/api/admin/stats/total-members");
                    const data = await response.json();

                    if (data.success) {
                        document.getElementById("totalMembersCount").textContent = data.total_members;
                        document.getElementById("totalTeamsCount").textContent = data.total_teams;
                    } else {
                        document.getElementById("totalMembersCount").textContent = "0";
                        document.getElementById("totalTeamsCount").textContent = "0";
                    }
                } catch (error) {
                    console.error("加载成员总数失败:", error);
                    document.getElementById("totalMembersCount").textContent = "0";
                    document.getElementById("totalTeamsCount").textContent = "0";
                }
            }

            // 邮箱搜索功能
            async function searchByEmail() {
                const email = document.getElementById("emailSearch").value.trim();

                if (!email) {
                    alert("请输入邮箱");
                    return;
                }

                try {
                    const response = await fetch(`/api/admin/teams/search?email=${encodeURIComponent(email)}`);
                    const data = await response.json();

                    if (data.success) {
                        if (data.teams.length === 0) {
                            alert(data.message || `未找到包含 ${email} 的Team`);
                        } else {
                            displayTeams(data.teams);
                            document.getElementById("clearSearchBtn").style.display = "inline-flex";
                            // 显示搜索结果提示
                            const container = document.getElementById("teamsList");
                            const tip = `<div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                搜索结果：找到 ${data.count} 个包含成员 <strong>${email}</strong> 的Team
                            </div>`;
                            container.innerHTML = tip + container.innerHTML;
                        }
                    } else {
                        alert(data.error || "搜索失败");
                    }
                } catch (error) {
                    console.error("搜索失败:", error);
                    alert("搜索请求失败");
                }
            }

            // 清除搜索，恢复全部列表
            function clearSearch() {
                document.getElementById("emailSearch").value = "";
                document.getElementById("clearSearchBtn").style.display = "none";
                displayTeams(allTeamsData);
            }

            // 支持回车键搜索
            document.addEventListener("DOMContentLoaded", function () {
                const searchInput = document.getElementById("emailSearch");
                if (searchInput) {
                    searchInput.addEventListener("keypress", function (e) {
                        if (e.key === "Enter") {
                            searchByEmail();
                        }
                    });
                }
            });

            function displayTeams(teams) {
                const container = document.getElementById("teamsList");

                if (teams.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm italic text-center py-4">暂无 Team</p>';
                    return;
                }

                // 使用表格形式渲染
                let html = `
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Team 名称</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">成员数</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">邮箱</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">到期时间</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">备注</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                `;

                teams.forEach((team) => {
                    let tokenStatusBadge = "";
                    if (team.token_status === "expired") {
                        tokenStatusBadge =
                            '<span class="ml-2 px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full border border-red-200 whitespace-nowrap flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>Token过期</span>';
                    } else if (team.token_error_count > 0) {
                        tokenStatusBadge = `<span class="ml-2 px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded-full border border-orange-200 whitespace-nowrap flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>错误${team.token_error_count}</span>`;
                    }

                    html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 whitespace-nowrap font-medium text-gray-900">
                            <div class="flex items-center">
                                ${team.name}
                                ${tokenStatusBadge}
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-500">
                            <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full font-medium">${team.member_count}/4</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-500 max-w-xs truncate" title="${team.email}">${team.email || "-"}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-500 text-xs">${formatDate(team.active_until)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-500 text-sm w-48">
                            <button onclick="editTeamNote(${team.id}, '${team.name.replace(/'/g, "\\'")}',${`'${(team.note || "")
                        .replace(/'/g, "\\'")
                        .replace(/\n/g, "\\n")}'`})" class="text-gray-600 hover:text-blue-600 flex items-center truncate w-full text-left" title="${
                        team.note || "点击添加备注"
                    }">
                                <svg class="w-4 h-4 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                <span class="truncate max-w-[140px]">${team.note || "添加备注"}</span>
                            </button>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center gap-2">
                                <button onclick="openInviteModal(${team.id}, '${team.name.replace(/'/g, "\\'")}')"
                                    class="text-green-600 hover:text-green-900 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                    邀请
                                </button>
                                <span class="text-gray-300">|</span>
                                <button onclick="toggleTeamPublic(${team.id}, ${!team.is_public})" class="${
                        team.is_public ? "text-blue-600 hover:text-blue-900" : "text-gray-400 hover:text-gray-600"
                    } flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                    ${team.is_public ? "公开" : "私有"}
                                </button>
                                <span class="text-gray-300">|</span>
                                <button onclick="generateTeamKey(${team.id}, '${team.name.replace(/'/g, "\\'")}')"
                                    class="text-indigo-600 hover:text-indigo-900 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg>
                                    邀请码
                                </button>
                                <span class="text-gray-300">|</span>
                                <button onclick="showMembers(${team.id}, '${team.name}')" class="text-blue-600 hover:text-blue-900 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                                    成员
                                </button>
                                <span class="text-gray-300">|</span>
                                <button onclick="showTeamDetails(${
                                    team.id
                                })" class="text-gray-600 hover:text-blue-600 flex items-center" title="查看详情">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    详情
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                });

                html += "</tbody></table>";
                container.innerHTML = html;
            }

            function formatDate(dateVal) {
                if (!dateVal) return "未知";
                try {
                    const date = new Date(dateVal);
                    if (isNaN(date.getTime())) return "Invalid Date";
                    return date.toLocaleString("zh-CN");
                } catch (e) {
                    return "Invalid Date";
                }
            }

            async function toggleTeamPublic(teamId, isPublic) {
                try {
                    const response = await fetch(`/api/admin/teams/${teamId}/public`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ is_public: isPublic }),
                    });
                    const data = await response.json();
                    if (data.success) {
                        loadTeams();
                    } else {
                        alert("更新失败: " + data.error);
                        loadTeams();
                    }
                } catch (e) {
                    alert("更新失败: " + e);
                    loadTeams();
                }
            }

            async function deleteExpiredTeams() {
                if (!(await showConfirm("确定要删除所有Token已过期的Team吗？\n\n此操作不可恢复！"))) return;

                try {
                    const response = await fetch("/api/admin/teams/delete-expired", {
                        method: "POST",
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast(data.message);
                        loadTeams();
                    } else {
                        alert("错误: " + data.error);
                    }
                } catch (error) {
                    alert("请求失败: " + error.message);
                }
            }

            // 编辑Team备注
            function editTeamNote(teamId, teamName, currentNote) {
                const modalHTML = `
                    <div id="noteModal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center">
                        <div class="bg-white rounded-xl shadow-2xl border border-gray-200 p-6 w-full max-w-md mx-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">编辑备注</h3>
                            <div class="mb-4">
                                <p class="text-gray-700 mb-3">为 <span class="font-semibold text-blue-600">${teamName}</span> 添加备注</p>
                                <textarea
                                    id="noteInput"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
                                    rows="4"
                                    placeholder="输入备注..."></textarea>
                            </div>
                            <div class="flex justify-end gap-3">
                                <button id="cancelNoteBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">取消</button>
                                <button id="saveNoteBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">保存</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML("beforeend", modalHTML);

                const modal = document.getElementById("noteModal");
                const input = document.getElementById("noteInput");
                const cancelBtn = document.getElementById("cancelNoteBtn");
                const saveBtn = document.getElementById("saveNoteBtn");

                // 设置当前备注
                input.value = currentNote || "";
                input.focus();

                // 取消按钮
                cancelBtn.onclick = () => {
                    modal.remove();
                };

                // 点击背景关闭
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };

                // 保存按钮
                saveBtn.onclick = async () => {
                    const note = input.value;
                    modal.remove();

                    try {
                        const response = await fetch(`/api/admin/teams/${teamId}/note`, {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ note: note }),
                        });

                        const data = await response.json();

                        if (data.success) {
                            showToast("备注保存成功！");
                            loadTeams();
                        } else {
                            alert("错误: " + data.error);
                        }
                    } catch (error) {
                        alert("请求失败: " + error.message);
                    }
                };
            }

            // 为指定Team生成邀请码
            async function generateTeamKey(teamId, teamName) {
                // 创建自定义对话框
                const modalHTML = `
                    <div id="teamKeyModal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center">
                        <div class="bg-white rounded-xl shadow-2xl border border-gray-200 p-6 w-full max-w-md mx-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">生成专属邀请码</h3>
                            <div class="mb-4">
                                <p class="text-gray-700 mb-3">为 <span class="font-semibold text-blue-600">${teamName}</span> 生成邀请码</p>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">选择类型</label>
                                        <select id="keyTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="permanent">永久邀请码</option>
                                            <option value="temp">1日试用邀请码</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">生成数量</label>
                                        <select id="keyCountSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="1">1个</option>
                                            <option value="2">2个</option>
                                            <option value="3">3个</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end gap-3">
                                <button id="cancelKeyBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">取消</button>
                                <button id="confirmKeyBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">生成</button>
                            </div>
                        </div>
                    </div>
                `;

                // 添加到页面
                document.body.insertAdjacentHTML("beforeend", modalHTML);

                const modal = document.getElementById("teamKeyModal");
                const select = document.getElementById("keyTypeSelect");
                const countSelect = document.getElementById("keyCountSelect");
                const cancelBtn = document.getElementById("cancelKeyBtn");
                const confirmBtn = document.getElementById("confirmKeyBtn");

                // 取消按钮
                cancelBtn.onclick = () => {
                    modal.remove();
                };

                // 点击背景关闭
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };

                // 生成按钮
                confirmBtn.onclick = async () => {
                    const isTemp = select.value === "temp";
                    const count = parseInt(countSelect.value);
                    modal.remove();

                    try {
                        const response = await fetch("/api/admin/keys", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                team_id: teamId,
                                is_temp: isTemp,
                                temp_hours: isTemp ? 24 : 0,
                                count: count,
                            }),
                        });

                        const data = await response.json();

                        if (data.success && data.keys && data.keys.length > 0) {
                            const keyCodes = data.keys.map((k) => k.key_code);

                            // 格式化剪贴板内容
                            let clipboardText = `${teamName}\n`;
                            keyCodes.forEach((code, index) => {
                                clipboardText += `${code}\n`;
                            });

                            await navigator.clipboard.writeText(clipboardText);
                            showToast(`已为 "${teamName}" 生成 ${count} 个${isTemp ? "1日试用" : "永久"}邀请码并复制到剪贴板`);
                            // 如果邀请码列表已加载，刷新它
                            if (typeof keysLoaded !== "undefined" && keysLoaded) {
                                loadKeys();
                            }
                        } else {
                            alert("错误: " + (data.error || "生成失败"));
                        }
                    } catch (error) {
                        alert("请求失败: " + error.message);
                    }
                };
            }

            window.onclick = function (event) {
                if (event.target.classList.contains("modal")) {
                    event.target.style.display = "none";
                }
            };

            // 来源管理弹窗控制
            function openSourcesModal() {
                document.getElementById("sourcesModal").style.display = "block";
                loadSources();
            }

            function closeSourcesModal() {
                document.getElementById("sourcesModal").style.display = "none";
            }
            // Toast 提示函数
            function showToast(message, type = "success") {
                let container = document.getElementById("toast-container");
                if (!container) {
                    container = document.createElement("div");
                    container.id = "toast-container";
                    container.className = "fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none";
                    document.body.appendChild(container);
                }

                const toast = document.createElement("div");
                toast.className = `px-6 py-3 rounded-lg shadow-lg text-white text-sm font-medium transition-all transform translate-y-4 opacity-0 pointer-events-auto flex items-center shadow-xl ${
                    type === "error" ? "bg-red-500" : "bg-green-500"
                }`;
                toast.innerHTML =
                    type === "error"
                        ? `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>${message}`
                        : `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>${message}`;

                container.appendChild(toast);

                // 动画显示
                requestAnimationFrame(() => {
                    toast.classList.remove("translate-y-4", "opacity-0");
                });

                setTimeout(() => {
                    toast.classList.add("opacity-0", "-translate-y-4");
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            async function openSystemConfigModal() {
                try {
                    const response = await fetch("/api/admin/system-config");
                    const data = await response.json();
                    if (data.success) {
                        // Team 弹窗内容
                        const popupConfig = data.config.find((c) => c.key === "team_popup_content");
                        if (popupConfig) {
                            document.getElementById("teamPopupContent").value = popupConfig.value;
                        }
                        // Bark 配置
                        const barkServerConfig = data.config.find((c) => c.key === "bark_server");
                        if (barkServerConfig) {
                            document.getElementById("barkServer").value = barkServerConfig.value || "https://api.day.app";
                        }
                        const barkKeyConfig = data.config.find((c) => c.key === "bark_key");
                        if (barkKeyConfig) {
                            document.getElementById("barkKey").value = barkKeyConfig.value;
                        }

                        // 满员预警配置
                        const warningEnabledConfig = data.config.find((c) => c.key === "team_full_warning_enabled");
                        const warningEnabled = warningEnabledConfig && warningEnabledConfig.value === "true";
                        document.getElementById("teamFullWarningEnabled").checked = warningEnabled;

                        const warningTemplateConfig = data.config.find((c) => c.key === "team_full_warning_template");
                        if (warningTemplateConfig) {
                            document.getElementById("teamFullWarningTemplate").value = warningTemplateConfig.value;
                        }

                        // 控制模板输入框显示
                        document.getElementById("warningTemplateGroup").style.display = warningEnabled ? "block" : "none";

                        document.getElementById("systemConfigModal").style.display = "flex";
                    } else {
                        showToast("获取配置失败: " + (data.error || "未知错误"), "error");
                    }
                } catch (error) {
                    showToast("获取配置失败: " + error.message, "error");
                }
            }

            function closeSystemConfigModal() {
                document.getElementById("systemConfigModal").style.display = "none";
            }

            async function saveSystemConfig() {
                const content = document.getElementById("teamPopupContent").value;
                const barkServer = document.getElementById("barkServer").value;
                const barkKey = document.getElementById("barkKey").value;
                const warningEnabled = document.getElementById("teamFullWarningEnabled").checked;
                const warningTemplate = document.getElementById("teamFullWarningTemplate").value;

                try {
                    const response = await fetch("/api/admin/system-config", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            team_popup_content: content,
                            bark_server: barkServer,
                            bark_key: barkKey,
                            team_full_warning_enabled: warningEnabled ? "true" : "false",
                            team_full_warning_template: warningTemplate,
                        }),
                    });
                    const data = await response.json();
                    if (data.success) {
                        showToast("配置已保存");
                        closeSystemConfigModal();
                    } else {
                        showToast("保存失败: " + (data.error || "未知错误"), "error");
                    }
                } catch (error) {
                    showToast("保存失败: " + error.message, "error");
                }
            }

            // 监听满员预警开关变化
            document.addEventListener("DOMContentLoaded", function () {
                const warningToggle = document.getElementById("teamFullWarningEnabled");
                if (warningToggle) {
                    warningToggle.addEventListener("change", function () {
                        document.getElementById("warningTemplateGroup").style.display = this.checked ? "block" : "none";
                    });
                }
            });

            async function testBark() {
                const server = document.getElementById("barkServer").value;
                const key = document.getElementById("barkKey").value;

                if (!key) {
                    showToast("请先填写 Bark Key", "error");
                    return;
                }

                try {
                    const response = await fetch("/api/admin/test-bark", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            server: server,
                            key: key,
                        }),
                    });
                    const data = await response.json();
                    if (data.success) {
                        showToast("测试消息发送成功，请检查手机通知");
                    } else {
                        showToast("发送失败: " + (data.error || "未知错误"), "error");
                    }
                } catch (error) {
                    showToast("发送请求失败: " + error.message, "error");
                }
            }

            async function testTeamFullWarning() {
                const server = document.getElementById("barkServer").value;
                const key = document.getElementById("barkKey").value;
                const template = document.getElementById("teamFullWarningTemplate").value;

                if (!key) {
                    showToast("请先填写 Bark Key", "error");
                    return;
                }

                if (!template) {
                    showToast("请先填写预警消息模板", "error");
                    return;
                }

                try {
                    const response = await fetch("/api/admin/test-team-full-warning", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            server: server,
                            key: key,
                            template: template,
                        }),
                    });
                    const data = await response.json();
                    if (data.success) {
                        showToast(data.message);
                    } else {
                        showToast("发送失败: " + (data.error || "未知错误"), "error");
                    }
                } catch (error) {
                    showToast("发送请求失败: " + error.message, "error");
                }
            }
        </script>

        <!-- 系统配置弹窗 -->
        <div
            id="systemConfigModal"
            class="modal fixed inset-0 z-50 bg-gray-900 bg-opacity-50 overflow-y-auto backdrop-blur-sm flex items-center justify-center"
            style="display: none">
            <div class="relative bg-white rounded-xl shadow-2xl border border-gray-200 p-6 w-full max-w-2xl mx-4 transition-all transform">
                <!-- 头部 -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c-.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        系统配置
                    </h2>
                    <button onclick="closeSystemConfigModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- 内容 -->
                <div class="space-y-4">
                    <!-- Bark 配置 -->
                    <div class="border-b border-gray-100 pb-4 mb-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-3">Bark 通知设置</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="barkServer" class="block text-sm font-medium text-gray-700 mb-1">Bark 服务器地址</label>
                                <input
                                    type="text"
                                    id="barkServer"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
                                    placeholder="https://api.day.app" />
                            </div>
                            <div>
                                <label for="barkKey" class="block text-sm font-medium text-gray-700 mb-1">Bark Key</label>
                                <div class="flex gap-2">
                                    <input
                                        type="text"
                                        id="barkKey"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
                                        placeholder="您的 Bark Key" />
                                    <button
                                        onclick="testBark()"
                                        class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 shadow-sm transition-colors text-sm whitespace-nowrap">
                                        测试
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 满员预警配置 -->
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <div class="flex items-center justify-between mb-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                <div>
                                    <label for="teamFullWarningEnabled" class="block text-sm font-medium text-gray-900">开启 Team 满员预警</label>
                                    <p class="text-xs text-gray-500 mt-0.5">当 Team 成员数(含管理员)达到 5 人时触发通知</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="teamFullWarningEnabled" class="sr-only peer" />
                                    <div
                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div id="warningTemplateGroup" class="mt-2" style="display: none">
                                <label for="teamFullWarningTemplate" class="block text-sm font-medium text-gray-700 mb-1">预警消息模板</label>
                                <div class="flex gap-2">
                                    <input
                                        type="text"
                                        id="teamFullWarningTemplate"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
                                        placeholder="Team [{team_name}] 即将满员！当前成员数: {current_count}, 新邀请: {email}" />
                                    <button
                                        onclick="testTeamFullWarning()"
                                        class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 shadow-sm transition-colors text-sm whitespace-nowrap">
                                        测试
                                    </button>
                                </div>
                                <p class="mt-1 text-xs text-gray-500">支持变量: {team_name}, {current_count}, {email}</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="teamPopupContent" class="block text-sm font-medium text-gray-700 mb-1">Team页面弹窗内容 (支持HTML)</label>
                        <textarea
                            id="teamPopupContent"
                            rows="10"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-mono text-sm"
                            placeholder="在此输入 HTML 内容..."></textarea>
                        <p class="mt-1 text-sm text-gray-500">此内容将在用户每天首次访问Team页面时弹出显示。</p>
                    </div>
                </div>

                <!-- 底部按钮 -->
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-100">
                    <button
                        onclick="closeSystemConfigModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button
                        onclick="saveSystemConfig()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        保存配置
                    </button>
                </div>
            </div>
        </div>
    </body>
</html>
