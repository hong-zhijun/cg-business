<!-- æ¥æºæ’è¡Œæ¦œå¼¹çª— -->
<div
    id="rankingModal"
    class="modal fixed inset-0 z-50 bg-gray-900 bg-opacity-50 overflow-y-auto backdrop-blur-sm flex items-center justify-center"
    style="display: none">
    <div class="relative bg-white rounded-xl shadow-2xl border border-gray-200 p-6 w-full max-w-2xl mx-4 transition-all transform">
        <!-- æ ‡é¢˜æ  -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                æ¥æºæ’è¡Œæ¦œ
            </h2>
            <div class="flex items-center gap-3">
                <select
                    id="rankingGroupType"
                    onchange="loadRankingData()"
                    class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1 pl-2 pr-8">
                    <option value="">å…¨éƒ¨ç»„åˆ«</option>
                    <option value="daily">å½“æ—¥ç»„</option>
                    <option value="past">å¾€æ—¥ç»„</option>
                    <option value="trial">è¯•ç”¨ç»„</option>
                    <option value="after_sales">å”®åç»„</option>
                    <option value="banned">å°ç¦ç»„</option>
                </select>
                <button onclick="closeRankingModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="mb-6 h-80 w-full">
            <canvas id="rankingChart"></canvas>
        </div>

        <!-- åˆ—è¡¨åŒºåŸŸ -->
        <div class="overflow-y-auto max-h-60 border-t border-gray-100 pt-4">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ’å</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¥æº</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">äººæ•°</th>
                    </tr>
                </thead>
                <tbody id="rankingListBody" class="bg-white divide-y divide-gray-200">
                    <!-- æ•°æ®åŠ è½½ä¸­... -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- å¼•å…¥ Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let rankingChart = null;

    function openRankingModal() {
        document.getElementById("rankingModal").style.display = "flex";
        loadRankingData();
    }

    function closeRankingModal() {
        document.getElementById("rankingModal").style.display = "none";
    }

    async function loadRankingData() {
        const groupType = document.getElementById("rankingGroupType").value;
        try {
            const response = await fetch(`/api/admin/stats/source-ranking?group_type=${groupType}`);
            const data = await response.json();

            if (data.success) {
                renderRanking(data.ranking);
            } else {
                console.error("è·å–æ’è¡Œæ¦œå¤±è´¥:", data.error);
                alert("è·å–æ’è¡Œæ¦œå¤±è´¥: " + data.error);
            }
        } catch (error) {
            console.error("è¯·æ±‚å¤±è´¥:", error);
            alert("è¯·æ±‚å¤±è´¥");
        }
    }

    function renderRanking(data) {
        // æ¸²æŸ“åˆ—è¡¨
        const tbody = document.getElementById("rankingListBody");
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-center text-gray-500 text-sm">æš‚æ— æ•°æ®</td></tr>';
        } else {
            tbody.innerHTML = data
                .map((item, index) => {
                    let rankClass = "text-gray-900";
                    let rankIcon = index + 1;

                    if (index === 0) {
                        rankClass = "text-yellow-600 font-bold";
                        rankIcon = "ğŸ¥‡";
                    } else if (index === 1) {
                        rankClass = "text-gray-600 font-bold";
                        rankIcon = "ğŸ¥ˆ";
                    } else if (index === 2) {
                        rankClass = "text-orange-600 font-bold";
                        rankIcon = "ğŸ¥‰";
                    }

                    return `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm ${rankClass}">
                            ${rankIcon}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${item.source}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right font-mono">
                            ${item.count}
                        </td>
                    </tr>
                `;
                })
                .join("");
        }

        // æ¸²æŸ“å›¾è¡¨
        renderChart(data);
    }

    function renderChart(data) {
        const ctx = document.getElementById("rankingChart").getContext("2d");

        // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œé”€æ¯å®ƒ
        if (rankingChart) {
            rankingChart.destroy();
        }

        const labels = data.map((item) => item.source);
        const counts = data.map((item) => item.count);

        // ç”Ÿæˆéšæœºé¢œè‰²æˆ–ä½¿ç”¨ä¸»é¢˜è‰²
        const bgColors = [
            "rgba(59, 130, 246, 0.7)", // blue-500
            "rgba(16, 185, 129, 0.7)", // emerald-500
            "rgba(245, 158, 11, 0.7)", // amber-500
            "rgba(239, 68, 68, 0.7)", // red-500
            "rgba(139, 92, 246, 0.7)", // violet-500
            "rgba(236, 72, 153, 0.7)", // pink-500
            "rgba(99, 102, 241, 0.7)", // indigo-500
        ];

        rankingChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "æˆå‘˜æ•°é‡",
                        data: counts,
                        backgroundColor: labels.map((_, i) => bgColors[i % bgColors.length]),
                        borderColor: labels.map((_, i) => bgColors[i % bgColors.length].replace("0.7", "1")),
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.6,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `äººæ•°: ${context.raw}`;
                            },
                        },
                    },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                        },
                        grid: {
                            color: "#f3f4f6",
                        },
                    },
                    x: {
                        grid: {
                            display: false,
                        },
                    },
                },
            },
        });
    }
</script>
