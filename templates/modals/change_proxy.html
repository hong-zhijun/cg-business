<!-- 7. 更换代理弹窗 -->
<div
    id="changeProxyModal"
    class="modal fixed inset-0 z-[60] bg-gray-900 bg-opacity-50 overflow-y-auto backdrop-blur-sm flex items-center justify-center"
    style="display: none">
    <div class="relative bg-white rounded-xl shadow-2xl border border-gray-200 p-8 w-full max-w-md mx-4 transition-all transform">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
                更换代理
            </h2>
            <button onclick="closeModal('changeProxyModal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">选择代理</label>
                <select
                    id="changeProxySelect"
                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors">
                    <option value="">不使用代理</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">选择要绑定到此 Team 的代理服务器。</p>
            </div>
        </div>

        <div class="mt-8 flex gap-3">
            <button
                onclick="closeModal('changeProxyModal')"
                class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                取消
            </button>
            <button
                onclick="submitChangeProxy()"
                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors shadow-sm">
                保存更改
            </button>
        </div>
    </div>
</div>

<script>
    let currentEditingTeamIdForProxy = null;

    function openChangeProxyModal(teamId, currentProxyId) {
        currentEditingTeamIdForProxy = teamId;
        
        // 填充下拉框
        const select = document.getElementById("changeProxySelect");
        // 清空现有选项（保留第一个）
        select.innerHTML = '<option value="">不使用代理</option>';
        
        if (window.allProxies) {
            window.allProxies.forEach(proxy => {
                const option = document.createElement("option");
                option.value = proxy.id;
                option.textContent = `${proxy.id} - ${proxy.protocol}://${proxy.ip}:${proxy.port} ${proxy.description ? '(' + proxy.description + ')' : ''}`;
                select.appendChild(option);
            });
        }

        // 设置当前选中值
        select.value = currentProxyId || "";

        openModal("changeProxyModal");
    }

    async function submitChangeProxy() {
        if (!currentEditingTeamIdForProxy) return;

        const select = document.getElementById("changeProxySelect");
        let proxyId = select.value;
        if (proxyId === "") {
            proxyId = null;
        } else {
            proxyId = parseInt(proxyId);
        }

        const btn = document.querySelector('#changeProxyModal button[onclick="submitChangeProxy()"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "保存中...";

        try {
            const response = await fetch(`/api/admin/teams/${currentEditingTeamIdForProxy}/proxy`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ proxy_id: proxyId })
            });

            const data = await response.json();

            if (data.success) {
                showToast("代理设置已更新");
                closeModal("changeProxyModal");
                
                // 更新本地数据和 UI
                const team = allTeamsData.find(t => t.id === currentEditingTeamIdForProxy);
                if (team) {
                    team.proxy_id = proxyId;
                    // 如果详情页是打开的，更新详情页
                    if (document.getElementById("teamDetailsModal").style.display !== "none") {
                         updateTeamDetailsProxyUI(team);
                    }
                }
            } else {
                alert("更新失败: " + (data.error || "未知错误"));
            }
        } catch (error) {
            alert("请求失败: " + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }
</script>
