<!-- 9. 邀请码记录 弹窗 -->
<div
    id="keysListModal"
    class="modal fixed inset-0 z-50 bg-gray-900 bg-opacity-50 overflow-y-auto backdrop-blur-sm flex items-center justify-center"
    style="display: none">
    <div
        class="relative bg-white rounded-xl shadow-2xl border border-gray-200 p-8 w-full max-w-4xl mx-4 transition-all transform h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-6 flex-shrink-0">
            <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                邀请码记录
            </h2>
            <button onclick="closeModal('keysListModal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <div class="flex flex-wrap gap-3 mb-4 flex-shrink-0">
            <button
                onclick="copyAllNormalKeys()"
                class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                复制所有普通码
            </button>
            <button
                onclick="copyAllTempKeys()"
                class="inline-flex items-center px-3 py-1.5 border border-red-200 shadow-sm text-sm font-medium rounded-lg text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                复制所有试用码
            </button>
            <button
                onclick="openCreateKeyModal()"
                class="inline-flex items-center px-3 py-1.5 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all ml-auto gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                新增
            </button>
        </div>

        <div id="keysList" class="space-y-3 overflow-y-auto flex-1 pr-2">加载中...</div>
    </div>
</div>

<script>
    let allKeys = [];
    let keysLoaded = false;

    function openKeysListModal() {
        openModal("keysListModal");
        loadKeys();
    }

    async function loadKeys() {
        try {
            const response = await fetch("/api/admin/keys");
            const data = await response.json();

            if (data.success) {
                allKeys = data.keys;
                displayKeys(data.keys);
            }
        } catch (error) {
            console.error("加载邀请码失败:", error);
        }
    }

    function displayKeys(keys) {
        const container = document.getElementById("keysList");

        if (!keys || keys.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm italic">暂无邀请码</p>';
            return;
        }

        let html = "";

        keys.forEach((key) => {
            const teamInfo = key.team_name 
                ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    ${key.team_name}
                   </span>`
                : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/></svg>
                    通用邀请码
                   </span>`;
            const keyCode = key.key_code;
            const hiddenKey = keyCode.length > 12 ? `${keyCode.substring(0, 6)}****${keyCode.substring(keyCode.length - 4)}` : keyCode;

            html += `
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-4 bg-white border border-gray-200 rounded-lg hover:border-blue-400 transition-colors shadow-sm">
                <div class="flex-1 w-full md:w-auto mb-3 md:mb-0">
                    <div>
                        <div class="flex items-center flex-wrap gap-2">
                            <code class="bg-yellow-50 text-yellow-700 px-2 py-1 rounded font-mono text-sm font-bold break-all border border-yellow-100" id="key_${
                                key.id
                            }" data-full="${keyCode}">${hiddenKey}</code>
                            <button onclick="toggleKeyVisibility(${key.id})" class="text-gray-400 hover:text-blue-600 px-2 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            </button>
                        </div>
                        <div class="mt-2 flex flex-wrap gap-2">
                            ${teamInfo}
                            ${
                                key.is_temp
                                    ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">1日试用</span>'
                                    : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">永久</span>'
                            }
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">使用 ${
                                key.usage_count
                            } 次</span>
                        </div>
                        <div class="mt-2 text-xs text-gray-500">
                            <span>创建时间: ${new Date(key.created_at).toLocaleString("zh-CN")}</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2 mt-2 md:mt-0">
                    <button onclick="copyKey('${keyCode}')" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-700 text-sm rounded hover:bg-gray-50 transition-colors flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>复制</button>
                    <button onclick="deleteKey(${
                        key.id
                    })" class="px-3 py-1.5 bg-red-50 text-red-600 border border-red-200 text-sm rounded hover:bg-red-100 transition-colors flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>删除</button>
                </div>
            </div>
        `;
        });

        container.innerHTML = html;
    }

    function toggleKeyVisibility(keyId) {
        const element = document.getElementById(`key_${keyId}`);
        const fullKey = element.getAttribute("data-full");
        const currentText = element.textContent;

        if (currentText.includes("****")) {
            element.textContent = fullKey;
        } else {
            const hiddenKey = fullKey.length > 12 ? `${fullKey.substring(0, 6)}****${fullKey.substring(fullKey.length - 4)}` : fullKey;
            element.textContent = hiddenKey;
        }
    }

    function copyKey(keyCode) {
        navigator.clipboard
            .writeText(keyCode)
            .then(() => {
                alert("✅ 邀请码已复制到剪贴板");
            })
            .catch((err) => {
                alert("❌ 复制失败: " + err);
            });
    }

    function copyAllNormalKeys() {
        const normalKeys = allKeys.filter((key) => !key.is_temp);

        if (normalKeys.length === 0) {
            alert("⚠️ 没有普通邀请码");
            return;
        }

        const keyCodes = normalKeys.map((key) => key.key_code).join("\n");

        navigator.clipboard
            .writeText(keyCodes)
            .then(() => {
                alert(`✅ 已复制 ${normalKeys.length} 个普通邀请码到剪贴板`);
            })
            .catch((err) => {
                alert("❌ 复制失败: " + err);
            });
    }

    function copyAllTempKeys() {
        const tempKeys = allKeys.filter((key) => key.is_temp);

        if (tempKeys.length === 0) {
            alert("⚠️ 没有1日试用邀请码");
            return;
        }

        const keyCodes = tempKeys.map((key) => key.key_code).join("\n");

        navigator.clipboard
            .writeText(keyCodes)
            .then(() => {
                alert(`✅ 已复制 ${tempKeys.length} 个1日试用邀请码到剪贴板`);
            })
            .catch((err) => {
                alert("❌ 复制失败: " + err);
            });
    }

    async function deleteKey(keyId) {
        if (!(await showConfirm("确定要删除这个邀请码吗？"))) return;

        try {
            const response = await fetch(`/api/admin/keys/${keyId}`, {
                method: "DELETE",
            });

            const data = await response.json();

            if (data.success) {
                alert("邀请码已删除");
                loadKeys();
            } else {
                alert("错误: " + data.error);
            }
        } catch (error) {
            alert("请求失败: " + error.message);
        }
    }
</script>
